---
title: Building Background Jobs with Taskless
---

# {% $frontmatter.title %}

In this guide, we're going to build a simple background job processor in Taskless. While we'll be creating placeholders for a variety of functions (using `console.log`), it's a great example of how you can use Taskless to move work out of the blocking path.

## Password Resets, but Faster and More Reliable

We're going to be fixing up a very simple password reset flow for a hypothetical website. A completed example is available [in the examples folder](https://github.com/taskless/taskless/tree/main/examples/next-postmark) if you'd like to just look at the final product.

In this example, we're using a third party service for sending email. We call it [Postmark](https://postmarkapp.com/), but it could be Mandrill, Mailchimp, or any other email gateway. Like any other service, there can be hiccups. We don't want the user waiting for a password reset to be stuck waiting on our server-to-server communication; this is doubly true if we need to retry sending the email multiple times. This process, _doing work in the background_ is where Taskless excels.

## Environment Setup

We'll start by creating a copy of our [next-guide](https://github.com/taskless/taskless/tree/main/examples/next-guide) example app. It was created using [create-next-app](https://www.npmjs.com/package/create-next-app) with `@taskless/next`, `@taskless/dev`, and `npm-run-all` added. We've also modified the `scripts` section to launch Taskless alongside our Next app.

> **Note:** You can also use npm or yarn for dependency management.

```sh
npx create-next-app@latest next-postmark --use-pnpm --example "https://github.com/taskless/examples/next-guide"
cd next-guide
touch .env.local
```

Secrets such as our postmark token go into `.env.local`

```
POSTMARK_TOKEN=your_postmark_api_token
```

That's it for setup. When we run `pnpm dev` from our console, we'll get the familiar next.js starter page. Next.js will run on port `3000`, while the Taskless Dev Server runs on `3001`,

![next13-home](https://user-images.githubusercontent.com/1795/216490240-3c8cd35e-ef55-42e3-bd47-03252c3d9f33.png)

## The Password Reset Page

Our password reset page isn't special; most of it is a clone of the landing page for the Next.js framework. We're going to keep things simple, so our example doesn't do any client-side validation. It's just the input and a submit button. The file is `/pages/auth/reset.tsx`:

```tsx
import Head from "next/head";
import { Inter } from "@next/font/google";
import home from "@/styles/Home.module.css";
import styles from "@/styles/PWReset.module.css";
import { useCallback, useRef, useState } from "react";

const inter = Inter({ subsets: ["latin"] });

export default function Home() {
  const [processing, setProcessing] = useState(false);
  const inputRef = useRef<HTMLInputElement>(null);
  const handleSubmit = useCallback(async () => {
    if (processing || !inputRef.current) {
      return;
    }
    setProcessing(true);

    setProcessing(true);
    try {
      const resp = await fetch("/api/auth/reset-slow", {
        method: "POST",
        body: JSON.stringify({
          email: inputRef.current.value,
        }),
      });
      const res = await resp.json();
      console.log(res);
    } catch (e) {
      console.error(e);
    } finally {
      setProcessing(false);
    }

    setProcessing(false);
  }, [processing]);

  return (
    <>
      <Head>
        <title>Password Reset Example - Taskless</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className={home.main}>
        <div className={home.center}>
          <div className={styles.grid}>
            <h1 className={inter.className}>Reset Your Password</h1>
            <div
              className={styles.grid}
              style={{ opacity: processing ? 0.5 : 1 }}
            >
              <input
                className={styles.input}
                type="email"
                placeholder="your email"
                ref={inputRef}
                readOnly={processing}
              />
              <button type="button" onClick={handleSubmit}>
                Forgot Password
              </button>
            </div>
          </div>
        </div>
      </main>
    </>
  );
}
```

As you interact with the page at [http://localhost:3000/auth/reset](http://localhost:3000/auth/reset), you'll notice that the page "hangs" for a moment or two. Looking in our console, we can see our Postmark service timed out.

```
[dev:next] ‚§µÔ∏è   Making request via reset-slow
[dev:next] [‚è≥] Check abuse rate limits
[dev:next] [‚úÖ] Check abuse rate limits
[dev:next] [‚è≥] Lookup user by email
[dev:next] [‚úÖ] Lookup user by email
[dev:next] [‚è≥] Save reset token
[dev:next] [‚úÖ] Save reset token
[dev:next] [‚è≥] Call Mail Service API
[dev:next] [üí•] Call Mail Service API Timed Out (7s)
```

üò¨

The user just sat waiting for seven seconds while we waited on our mail service to respond. Even worse, we never sent the email! Instead of building retry logic, error handling, and backoffs for every endpoint, we can just use Taskless.

## Enter the Taskless Queue

Queues in Taskless are small, publicly accessible functions in your app. We recommend making them available inside of a `queues` directory. We've taken the slow parts (literally) of our API endpoint and put them inside of a Taskless runner:

```ts
import { createQueue } from "@taskless/next";
import { performSlowGlitchyPasswordReset } from "../auth/reset-slow";

interface ResetData {
  email: string;
}

export default createQueue<ResetData>(
  "password-reset",
  "/api/queues/reset",
  async (job, api) => {
    await performSlowGlitchyPasswordReset();
    return { ok: true };
  }
);
```

It's our same glitchy and unreliable password reset service, but this time it's bundled up in Taskless. Check the `Use Taskless` box on our password reset form, and the reset request will be sent to `/api/auth/reset-fast`.

```ts
import type { NextApiRequest, NextApiResponse } from "next";
import crypto from "crypto";
import reset from "../queues/reset";

type Data = {
  ok: boolean;
};

const handler = async (req: NextApiRequest, res: NextApiResponse<Data>) => {
  console.info("‚§µÔ∏è   Making request via reset-fast");

  if (!req.body.email) {
    throw new Error("no email");
  }
  const email = (
    Array.isArray(req.body.email) ? req.body.email : [req.body.email]
  )[0];

  const key = crypto
    .createHash("sha256")
    .update(email ?? "")
    .digest("hex")
    .toString();

  await reset.enqueue(key, { email }, { retries: 3 });

  res.status(200).json({ ok: true });
};

export default handler;
```

This follows the `createQueue` example from the [next.js + taskless docs](/docs/get-started/nextjs). Now, when our password reset flow times out and fails, the request is automatically requeued and retried. A log of the action shows up in the Taskless Dev Server too.

```
[dev:next] ‚§µÔ∏è   Making request via reset-fast
[dev:next] [‚è≥] Check abuse rate limits
[dev:next] [‚úÖ] Check abuse rate limits
[dev:next] [‚è≥] Lookup user by email
[dev:next] [‚úÖ] Lookup user by email
[dev:next] [‚è≥] Save reset token
[dev:next] [‚úÖ] Save reset token
[dev:next] [‚è≥] Call Mail Service API
[dev:next] [üí•] Call Mail Service API Timed Out (7s)
[dev:next] Error: Service Timed Out
[dev:next]     at ...
[dev:t   ] info   - 17:10:41.41 (root) FAIL of c496c6be-cc69-507f-bd14-4e4380be8945
[dev:t   ] error  - 17:10:41.41 (root) Received non-2xx response
[dev:next] [‚è≥] Check abuse rate limits
[dev:next] [‚úÖ] Check abuse rate limits
[dev:next] [‚è≥] Lookup user by email
[dev:next] [‚úÖ] Lookup user by email
[dev:next] [‚è≥] Save reset token
[dev:next] [‚úÖ] Save reset token
[dev:next] [‚è≥] Call Mail Service API
[dev:next] [‚úÖ] Call Mail Service API
[dev:t   ] info   - 17:11:15.745 (root) ACK of c496c6be-cc69-507f-bd14-4e4380be8945
```

![fail-success](https://user-images.githubusercontent.com/1795/216490321-b5187cda-76b2-44f9-9a55-dd6a998c1eb1.png)

## What's Next

Background jobs are just one of the many things you can do with Taskless. Check out the [getting started guide](/docs/welcome) for other guides and ideas.
